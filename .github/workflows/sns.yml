name: X (Twitter) Auto Posting

on:
  # æ¯æ™‚00åˆ†ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆJSTæ™‚åˆ»ã§ã®æŸ”è»ŸãªæŠ•ç¨¿ã‚’å¯èƒ½ã«ã™ã‚‹ï¼‰
  schedule:
    - cron: '0 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ (true/false)'
        required: false
        default: 'false'
        type: boolean

# GitHub Actionsæ¨©é™è¨­å®šï¼ˆæŠ•ç¨¿æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒŸãƒƒãƒˆã«å¿…è¦ï¼‰
permissions:
  contents: write  # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ãã¨ã‚³ãƒŸãƒƒãƒˆç”¨

env:
  TZ: Asia/Tokyo

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Verify environment
      run: |
        echo "ç¾åœ¨æ™‚åˆ» (JST): $(TZ=Asia/Tokyo date)"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"
        echo "TW_API_KEY is set: $([[ -n "$TW_API_KEY" ]] && echo "YES" || echo "NO")"
        
    - name: Lint files
      run: npm run lint
      
    - name: Run posting (simulation)
      if: ${{ inputs.dry_run == 'true' || inputs.dry_run == true }}
      env:
        TW_API_KEY: ${{ secrets.TW_API_KEY }}
        TW_API_KEY_SECRET: ${{ secrets.TW_API_KEY_SECRET }}
        TW_ACCESS_TOKEN: ${{ secrets.TW_ACCESS_TOKEN }}
        TW_ACCESS_TOKEN_SECRET: ${{ secrets.TW_ACCESS_TOKEN_SECRET }}
      run: |
        echo "=== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ ==="
        npm run plan
        npm run run
        
    - name: Run posting (production)
      if: ${{ inputs.dry_run != 'true' && inputs.dry_run != true }}
      env:
        TW_API_KEY: ${{ secrets.TW_API_KEY }}
        TW_API_KEY_SECRET: ${{ secrets.TW_API_KEY_SECRET }}
        TW_ACCESS_TOKEN: ${{ secrets.TW_ACCESS_TOKEN }}
        TW_ACCESS_TOKEN_SECRET: ${{ secrets.TW_ACCESS_TOKEN_SECRET }}
      run: |
        echo "=== æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ (æœŸæ—¥åˆ°æ¥åˆ†ã®ã¿) ==="
        npm run plan
        node cli/index.js run --due-only --save-log
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: posting-logs
        path: logs/
        retention-days: 30
        
    - name: Commit posted files
      if: ${{ inputs.dry_run != 'true' && inputs.dry_run != true }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # posted ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        mkdir -p sns/posted
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [[ -n $(git status --porcelain) ]]; then
          echo "æŠ•ç¨¿æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
          git add sns/posted/ || echo "sns/posted/ ã«è¿½åŠ ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          git add . || true
          git commit -m "chore: æŠ•ç¨¿æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹• [skip ci]

          ğŸ¤– GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
          å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" || echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          
          git push || echo "ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ã‚³ãƒŸãƒƒãƒˆå‡¦ç†å®Œäº†"
        else
          echo "å¤‰æ›´ãªã—: ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi
        
    - name: Notification on failure
      if: failure()
      run: |
        echo "ğŸš¨ æŠ•ç¨¿å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"